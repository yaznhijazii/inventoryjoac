<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Delivery Dashboard â€” Interactive</title>

<!-- XLSX -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- Tajawal font -->
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f6f8fb; --card:#fff; --primary:#0b67ff; --accent:#1cc4a5; --muted:#98a2b3; --radius:12px;
}
*{box-sizing:border-box}
body{margin:0;font-family:'Tajawal',sans-serif;background:var(--bg);color:#0f1724;transition:background 0.3s,color 0.3s}
header{background:linear-gradient(90deg,var(--primary),#24c0ff 70%);color:white;padding:28px 20px;border-bottom-left-radius:18px;border-bottom-right-radius:18px;box-shadow:0 8px 30px rgba(11,103,255,0.12)}
header h1{margin:0;font-weight:700;font-size:1.6rem;animation:fadeIn 1s ease forwards}
header p{margin:6px 0 0;font-weight:500;opacity:0.9}
.greeting{overflow:hidden;white-space:nowrap;font-weight:600;margin-top:8px}
.greeting .text{display:inline-block;transform:translateX(-120%);animation:slidein 1s cubic-bezier(.22,.9,.33,1) forwards;font-size:1.05rem}
@keyframes slidein{to{transform:translateX(0%)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.wrap{max-width:1200px;margin:26px auto;padding:18px}
.grid{display:grid;grid-template-columns:1fr 480px;gap:18px}
.panel{background:var(--card);border-radius:var(--radius);padding:16px;box-shadow:0 6px 22px rgba(15,23,36,0.06);transition:transform 0.25s}
.panel:hover{transform:translateY(-3px)}
.sheet-row{display:flex;align-items:center;gap:12px;padding:12px;border-radius:10px;border:1px dashed #e6eef9;margin-bottom:12px;transition:background 0.25s}
.sheet-row.dragover{background:#eef6ff}
.sheet-left{flex:1}
.sheet-left strong{display:block;font-weight:700}
.sheet-left small{display:block;color:var(--muted);margin-top:4px;font-size:0.86rem}
.sheet-actions{display:flex;flex-direction:column;gap:8px;align-items:flex-end}
input[type=file]{padding:10px;border-radius:8px;border:1px solid #e8f0ff;background:#f7fbff;cursor:pointer;transition:background 0.2s}
input[type=file]:hover{background:#eef6ff}
.btn{background:var(--primary);color:white;padding:9px 12px;border-radius:9px;border:none;cursor:pointer;font-weight:600;transition:all 0.2s}
.btn.secondary{background:var(--accent)}
.btn.ghost{background:transparent;color:var(--primary);border:1px solid rgba(11,103,255,0.18)}
.btn:disabled{opacity:0.5;cursor:not-allowed}
.progress-wrapper{width:220px}
.progress{width:100%;height:8px;background:#eef6ff;border-radius:999px;overflow:hidden}
.bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),#19b3a0);transition:width .35s ease}
.spinner{width:22px;height:22px;border-radius:50%;border:3px solid rgba(0,0,0,0.08);border-top-color:var(--primary);animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.summary .card{background:linear-gradient(180deg,#fff,#fbfeff);border-radius:12px;padding:14px;box-shadow:0 6px 18px rgba(15,23,36,0.04);margin-bottom:12px;transition:transform 0.2s}
.summary .card:hover{transform:scale(1.02)}
.report-table{width:100%;border-collapse:collapse;font-size:0.95rem}
.report-table th{ text-align:left;padding:8px;background:rgba(11,103,255,0.12);color:var(--primary);font-weight:700}
.report-table td{padding:8px;border-bottom:1px solid #f1f6fb}
.preview{max-height:300px;overflow:auto;border-radius:10px;border:1px solid #edf4ff;padding:10px}
table.preview-table{width:100%;border-collapse:collapse;font-size:0.92rem}
table.preview-table th{background:#f3f8ff;color:var(--primary);padding:8px;text-align:left;position:sticky;top:0}
table.preview-table td{padding:8px;border-bottom:1px solid #f5f7fb}
footer{margin-top:20px;text-align:center;color:#6b7280;font-size:0.9rem}
.brand{font-weight:700;color:var(--primary)}
.controls-row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:10px}
@media (max-width:980px){.grid{grid-template-columns:1fr}.progress-wrapper{width:140px}}
.confetti-piece {
  position: fixed;
  width: 8px;
  height: 8px;
  background-color: red;
  opacity: 0.8;
  pointer-events: none;
  z-index: 9999;
  border-radius: 3px;
  will-change: transform, opacity;
}
</style>
</head>
<body>

<header>
  <div class="wrap title-row" style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
    <div>
      <h1>Delivery Dashboard</h1>
      <p class="subtitle">Upload, Process & Inspect deliveries â€” Interactive</p>
      <div class="greeting"><span class="text" id="greetingText">Ù…Ø±Ø­Ø¨Ø§Ù‹ Waad!</span></div>
    </div>
    <div style="text-align:right">
      <div style="font-size:0.95rem;opacity:0.85" id="timeNow"></div>
    </div>
  </div>
</header>

<main class="wrap">
<div class="grid">
  <div id="uploadSection">
    <div class="panel">
      <h3>Upload Sheets (Drag & Drop or Click)</h3>
      <p style="color:var(--muted)">Ø±ÙØ¹ ÙƒÙ„ Ù…Ù„Ù Ù„ÙˆØ­Ø¯Ù‡ â€” Ø§Ø¶ØºØ· "Process" Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©. Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ø³ÙŠÙƒÙˆÙ† ÙŠØ¯ÙˆÙŠØ§Ù‹.</p>
      <div id="sheetsContainer"></div>
      <div class="controls-row">
        <button id="downloadMergedBtn" class="btn" disabled>Download Merged</button>
        <button id="clearAllBtn" class="btn ghost">Clear All</button>
      </div>
    </div>
  </div>

  <aside>
    <div class="summary" id="summaryCards">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Mini Report</div>
          <div style="text-align:right">
            <div style="font-size:0.9rem;color:var(--muted)">Total records</div>
            <div id="totalRecords" style="font-weight:700;font-size:1.2rem">0</div>
          </div>
        </div>
        <table class="report-table" id="reportTable">
          <thead><tr><th>Sheet</th><th>Records</th><th>Total Amount</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card" style="padding-bottom:14px">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Chart</div>
          <div style="color:var(--muted);font-size:0.9rem">Records per sheet</div>
        </div>
        <canvas id="miniChart" style="height:180px;margin-top:10px"></canvas>
      </div>

      <div class="card">
        <div style="font-weight:700;margin-bottom:8px">Preview (last processed)</div>
        <div class="preview">
          <table class="preview-table" id="previewTable">
            <thead><tr><th>Invoice ID</th><th>Received Amount</th><th>Received Date</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </aside>
</div>
</main>

<footer>
  <div>Â© <span id="year"></span> <span class="brand">Automation</span> â€” Powered by Yazan Hijazi</div>
</footer>

<script>
// ======= Initialization =======
const sheetsOrder = ['DeliveryOne','IDelivery','Zohal','Mailers'];
const skipRowsMap = {DeliveryOne:2, IDelivery:0, Zohal:0, Mailers:3};
let processedMap = {};
let mergedData = [];

(function initGreeting(){
  const now = new Date();
  const h = now.getHours();
  
  // Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¨Ø§Ù„Ù‡ÙŠØ¯Ø±
  document.getElementById('timeNow').innerText = now.toLocaleString('ar-EG',{
    weekday:'long', day:'numeric', month:'short', hour:'2-digit', minute:'2-digit'
  });

  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ØªØ­ÙŠØ© + Ø§ÙŠÙ…ÙˆØ¬ÙŠ
  let emoji = 'ğŸŒ';
  let greetText = 'ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±';
  if(h >= 12 && h < 18){
    greetText = 'Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±';
    emoji = 'ğŸŒ‡';
  } else if(h >= 18){
    greetText = 'Ù…Ø³Ø§Ø¡ Ù…ØªØ£Ø®Ø±';
    emoji = 'ğŸŒ™';
  }

  // Ø§Ø³Ù… ÙˆØ¹Ø¯ Ø¨Ø§Ù„Ù€Bold ÙÙ‚Ø·
  const nameSpan = `<strong>ÙˆØ¹Ø¯</strong>`;

  // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
  document.getElementById('greetingText').innerHTML = `${emoji} ${greetText}, ${nameSpan}!`;

  // Ø§Ù„Ø³Ù†Ø©
  document.getElementById('year').textContent = now.getFullYear();
})();


// ======= Upload Rows =======
const container = document.getElementById('sheetsContainer');
sheetsOrder.forEach(name=>{
  const row = document.createElement('div');
  row.className='sheet-row';
  row.innerHTML=`
    <div class="sheet-left">
      <strong>${name}</strong>
      <small>Upload ${name} sheet (.xls/.xlsx)</small>
      <div style="margin-top:8px;color:var(--muted);font-size:0.86rem" id="${name}Status">No file selected</div>
    </div>
    <div class="sheet-actions">
      <input type="file" accept=".xls,.xlsx" id="${name}Input">
      <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
        <div class="progress-wrapper">
          <div class="progress"><div class="bar" id="${name}Bar"></div></div>
        </div>
        <div id="${name}Spinner" style="display:none"><div class="spinner"></div></div>
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn ghost" id="${name}ProcessBtn">Process</button>
        <button class="btn secondary" id="${name}DownloadBtn" disabled>Download</button>
      </div>
    </div>`;
  container.appendChild(row);

  const fileInput = row.querySelector(`#${name}Input`);
  const statusEl = row.querySelector(`#${name}Status`);
  fileInput.addEventListener('change',e=>{const f=e.target.files[0]; statusEl.textContent=f?`${f.name} selected`:'No file selected';});
  row.querySelector(`#${name}ProcessBtn`).addEventListener('click',()=>processSheet(name));
  row.querySelector(`#${name}DownloadBtn`).addEventListener('click',()=>downloadSheetFile(name));

  // Drag & Drop
  row.addEventListener('dragover',e=>{e.preventDefault();row.classList.add('dragover');});
  row.addEventListener('dragleave',e=>row.classList.remove('dragover'));
  row.addEventListener('drop',e=>{
    e.preventDefault();row.classList.remove('dragover');
    const file=e.dataTransfer.files[0];
    if(file) fileInput.files = e.dataTransfer.files;
    statusEl.textContent = file?`${file.name} selected`:'No file selected';
  });
});

// ======= Excel Reading & Normalization =======
async function readExcel(file,skipRows=0){const buff=await file.arrayBuffer();const wb=XLSX.read(buff,{type:'array'});const sheet=wb.Sheets[wb.SheetNames[0]];return XLSX.utils.sheet_to_json(sheet,{defval:'',range:skipRows});}
function normalizeDate(v){
  if(!v) return '';
  if(v instanceof Date && !isNaN(v)) return v.toLocaleDateString();
  if(!isNaN(v) && v>30){const d=new Date((v-25569)*86400*1000);return d.toLocaleDateString();}
  const parts = String(v).split(/\/|-/);
  if(parts.length>=3){let dd,mm,yyyy;if(parts[0].length===4){yyyy=parts[0];mm=parts[1];dd=parts[2];}else{dd=parts[0];mm=parts[1];yyyy=parts[2];}const d=new Date(`${yyyy}-${mm.padStart(2,'0')}-${dd.padStart(2,'0')}`);if(!isNaN(d))return d.toLocaleDateString();}
  return String(v);
}

// ======= Filter Sheets =======
function filterSheet(data, sheetName){
  if(!data||!data.length) return [];
  if(sheetName==='DeliveryOne'){
    return data.filter((r,i)=>i>=2).filter(r=>['DELIVERED WITH COLLECTION EXCEPTION','DELIVERED WITH COLLECTION','DELIVERED'].some(s=>(r['Status']||r['status']||'').toString().trim().toUpperCase().includes(s)))
      .map(r=>{let id=(r['Contact Person']||r['Contact']||'').toString().trim();if(!id||id.startsWith('9')||id.startsWith('8'))return null;let amount=Number(r['Collection']||0);if(isNaN(amount))amount=0;let rawDate=r['Status Date']||r['status date']||'';let date='';if(rawDate){let d=typeof rawDate==='number'?XLSX.SSF.parse_date_code(rawDate):new Date(rawDate);if(typeof d==='object'&&d.y)d=new Date(d.y,d.m-1,d.d);if(d&&!isNaN(d.getTime()))date=`${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;}return {ID:id,Amount:amount,Date:date};}).filter(r=>r);
  }else if(sheetName==='IDelivery'){
    return data.map(r=>{let id=r['Ø±Ù‚Ù… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ÙŠØ©']||r['Reference']||r['Ref']||'';let amount=Number(r['Ø§Ù„ØªØ­ØµÙŠÙ„']||r['Amount']||0);let rawDate=r['ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙˆØµÙŠÙ„']||r['Date']||'';let dateStr='';if(typeof rawDate==='number'){let d=new Date((rawDate-25569)*86400*1000);dateStr=`${d.getMonth()+1}/${d.getDate()}/${d.getFullYear()}`;}else if(rawDate instanceof Date){dateStr=`${rawDate.getMonth()+1}/${rawDate.getDate()}/${rawDate.getFullYear()}`;}else if(rawDate){dateStr=String(rawDate).split(' ')[0];}return {ID:id,Amount:amount,Date:dateStr};}).filter(r=>r.ID&&!r.ID.startsWith('9'));
  }else if(sheetName==='Zohal'){
    return data.map(r=>({ID:r['Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù…Ø±Ø¬Ø¹ÙŠ']||r['Reference']||'',Amount:Number(r['Ù‚ÙŠÙ…Ø© Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ØªØ­ØµÙŠÙ„']||r['Amount']||0),Date:normalizeDate(r['Ø£Ù†Ø´Ø¦ ÙÙŠ']||r['created_at']||'')})).filter(r=>r.Amount>0);
  }else if(sheetName==='Mailers'){
    return data.map(r=>({ID:r['Reference Number2']||r['reference2']||'',Amount:Number(r['COD Value']||r['Amount']||0),Date:normalizeDate(r['Status Date']||r['status_date']||r['Date']||'')})).filter(r=>r.ID&&!r.ID.startsWith('9')&&!r.ID.startsWith('8'));
  }
  return [];
}

// ======= Show Preview =======
function showPreview(data){const tbody=document.querySelector('#previewTable tbody');tbody.innerHTML='';data.slice(0,10).forEach(r=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${r.ID}</td><td>${r.Amount}</td><td>${r.Date}</td>`;tbody.appendChild(tr);});}

// ======= Process Sheet =======
async function processSheet(sheetName){
  const fileInput=document.getElementById(sheetName+'Input');
  if(!fileInput.files[0]) return alert('Please select a file first!');
  const bar=document.getElementById(sheetName+'Bar'); const spinner=document.getElementById(sheetName+'Spinner');
  bar.style.width='0%'; spinner.style.display='inline-block';
  const data=await readExcel(fileInput.files[0],skipRowsMap[sheetName]||0);
  const filtered=filterSheet(data,sheetName);
  processedMap[sheetName]=filtered;
  mergedData=Object.values(processedMap).flat();
  bar.style.width='100%'; spinner.style.display='none';
  document.getElementById(sheetName+'DownloadBtn').disabled=false;
  updateStats();
  showPreview(filtered);
  document.getElementById('downloadMergedBtn').disabled = Object.keys(processedMap).length===0?true:false;
}

// ======= Update Summary =======
function updateStats(){
  const total=document.getElementById('totalRecords'); total.textContent=mergedData.length;
  const totalAmount = mergedData.reduce((a,b)=>a+b.Amount,0); document.getElementById('liveAmount').textContent=totalAmount.toFixed(2);
  const tbody=document.querySelector('#reportTable tbody'); tbody.innerHTML='';
  Object.keys(processedMap).forEach(s=>{
    const rows=processedMap[s]||[];
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${s}</td><td>${rows.length}</td><td>${rows.reduce((a,b)=>a+b.Amount,0).toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });
  updateChart();
}

// ======= Chart =======
let chartInstance=null;
function updateChart(){
  const ctx=document.getElementById('miniChart').getContext('2d');
  const labels=Object.keys(processedMap); const values=labels.map(l=>processedMap[l].length);
  if(chartInstance) chartInstance.data={labels, datasets:[{label:'Records',data:values,backgroundColor:'#0b67ff88'}]}, chartInstance.update();
  else chartInstance=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Records',data:values,backgroundColor:'#0b67ff88'}]},options:{responsive:true,plugins:{legend:{display:false}}}});
}

// ======= Download Individual Sheet =======
function downloadSheetFile(sheetName){
  const data=processedMap[sheetName]||[]; if(!data.length)return;
  const ws=XLSX.utils.json_to_sheet(data); const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,sheetName); XLSX.writeFile(wb,sheetName+'_Processed.xlsx');
}

// ======= Download Merged =======
document.getElementById('downloadMergedBtn').addEventListener('click',()=>{
  if(!mergedData.length) return alert('No data!');
  const requiredSheets = sheetsOrder.filter(s=>document.getElementById(s+'Input').files.length>0);
  if(requiredSheets.some(s=>!processedMap[s])) return alert('Please process all uploaded sheets before downloading merged file!');

  const payload = mergedData.map(r=>({InvoiceID:r.ID, ReceivedAmount:r.Amount, ReceivedDate:r.Date}));
  const ws=XLSX.utils.json_to_sheet(payload); const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,'Merged'); 
  XLSX.writeFile(wb,'Merged_Delivery.xlsx');

  // ØªØ´ØºÙŠÙ„ Confetti Ø¨Ø¹Ø¯ Ø§Ù„ØªÙ†Ø²ÙŠÙ„
  launchConfetti();
});


// ======= Clear All =======
document.getElementById('clearAllBtn').addEventListener('click',()=>{
  processedMap={}; mergedData=[]; updateStats(); showPreview([]);
  sheetsOrder.forEach(s=>{
    const fi=document.getElementById(s+'Input'); fi.value=''; document.getElementById(s+'Status').textContent='No file selected';
    document.getElementById(s+'Bar').style.width='0%'; document.getElementById(s+'DownloadBtn').disabled=true;
  });
  document.getElementById('downloadMergedBtn').disabled=true;
});

// ======= Refresh Btn =======
document.getElementById('refreshBtn').addEventListener('click',()=>{updateStats();showPreview([]);});
function launchConfetti(){
  const colors = ['#ff595e','#ffca3a','#8ac926','#1982c4','#6a4c93'];
  const count = 150;

  for(let i=0;i<count;i++){
    const conf = document.createElement('div');
    conf.className = 'confetti-piece';
    conf.style.backgroundColor = colors[Math.floor(Math.random()*colors.length)];
    conf.style.left = Math.random()*window.innerWidth+'px';
    conf.style.top = '-10px';
    conf.style.width = conf.style.height = 5+Math.random()*5+'px';
    conf.style.opacity = Math.random()*0.8+0.2;
    document.body.appendChild(conf);

    const fallDuration = 2000 + Math.random()*2000;
    const endX = (Math.random()-0.5)*200; // Ø­Ø±ÙƒØ© ÙŠÙ…ÙŠÙ† ÙˆÙŠØ³Ø§Ø±
    const endY = window.innerHeight + 20;

    conf.animate([
      {transform:`translate(0,0) rotate(0deg)`, opacity:conf.style.opacity},
      {transform:`translate(${endX}px,${endY}px) rotate(${Math.random()*720}deg)`, opacity:0}
    ],{
      duration:fallDuration,
      easing:'ease-out'
    });

    setTimeout(()=>{conf.remove()},fallDuration);
  }
}

</script>
</body>
</html>
